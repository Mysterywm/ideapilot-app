import{useCallback as k,useEffect as I,useSyncExternalStore as A}from"react";import{createContext as b,useContext as w}from"react";var m=class{map=new Map;get(t,r){let a=this.map.get(t);if(!a){let e={state:"initial",isLoading:!1,data:r,error:void 0};return this.map.set(t,e),e}return a}set(t,r){this.map.set(t,r)}delete(t){this.map.delete(t)}},x=b({listeners:new Set,stateMap:new m});function E(){return w(x)}var d={api:{hostname:"api.lanyard.rest",secure:!0}};import{API as P}from"@prequist/lanyard";var T=class extends Error{constructor(r,a,e){super(e.error.message);this.request=r;this.response=a;this.body=e;this.code=this.response.status}code};function g(s,t=d){return`${t.api.secure?"https":"http"}://${t.api.hostname}/v1/users/${s}`}async function S(s,t=d){let r=g(s,t),a={method:"GET",signal:t.controller?.signal??null,headers:{Accept:"application/json"}},e=new Request(r,a),i=await fetch(e),p=await i.json();return P.isErrored(i,p)?{success:!1,error:new T(e,i,p)}:{success:!0,data:p.data}}import{useInsertionEffect as L,useCallback as h,useRef as v}from"react";var O=typeof window<"u"?L:()=>{};function f(s){let t=v(s);return O(()=>{t.current=s},[s]),h(function(){return t.current.apply(this,arguments)},[])}function Q(s,t){let r={...d,...t},a=E(),e=f(n=>{a.stateMap.set(s,n);for(let l of a.listeners)l()}),i=f(()=>{let n=a.stateMap.get(s,r.initialData);if(!n)throw new Error("State not found");return n}),p=f(n=>{e({...i(),isLoading:n})}),c=f(async n=>{if(i().isLoading)return;p(!0);let l=await S(s,n?{...r,controller:n}:r);l.error?e({...i(),state:"errored",error:l.error,isLoading:!1}):e({...i(),state:"loaded",data:l.data,isLoading:!1})});I(()=>{let n=new AbortController;return c(n),()=>{n.abort()}},[c]);let o=k(n=>(a.listeners.add(n),()=>{a.listeners.delete(n)}),[s]);return{...A(o,i,i),revalidate:c}}import{useEffect as _,useState as N}from"react";var R=(e=>(e[e.Event=0]="Event",e[e.Hello=1]="Hello",e[e.Initialize=2]="Initialize",e[e.Heartbeat=3]="Heartbeat",e))(R||{}),D=(r=>(r.INIT_STATE="INIT_STATE",r.PRESENCE_UPDATE="PRESENCE_UPDATE",r))(D||{}),C=1e4;function Z(s,t){let r={...d,...t},[a,e]=N(),p=`${r.api.secure?"wss":"ws"}://${r.api.hostname}/socket`;return _(()=>{if(typeof window>"u")return;if(!("WebSocket"in window))throw new Error("Lanyard failed to connect: The WebSocket API is not supported in this browser.");let c,o;function y(){c&&clearInterval(c),o=new WebSocket(p),o.addEventListener("close",y),o.addEventListener("message",n)}function n(l){let u=JSON.parse(l.data);switch(u.op){case 1:{c=setInterval(()=>{o.readyState===o.OPEN&&o.send(JSON.stringify({op:3}))},u.d?.heartbeat_interval??C),o.readyState===o.OPEN&&o.send(JSON.stringify({op:2,d:{subscribe_to_id:s}}));break}case 0:{switch(u.t){case"INIT_STATE":case"PRESENCE_UPDATE":{u.d&&e(u.d);break}default:break}break}default:break}}return y(),()=>{clearInterval(c),o.removeEventListener("close",y),o.removeEventListener("message",n),o.close()}},[p]),a??r.initialData}export{d as DEFAULT_OPTIONS,T as LanyardError,D as SocketEvents,R as SocketOpcode,S as get,g as getURL,Q as useLanyard,Z as useLanyardWS};
